<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link id="fav" rel="shortcut icon">

  <!-- <script src="./scripts/socket.io-client/dist/socket.io.min.js"></script> -->
</head>
<body style="background-color: #0f0f0f;">
  <img id="prev">
  <script>
    const transparent = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAAAXNSR0IB2cksfwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAANQTFRFAAAAp3o92gAAAAF0Uk5TAEDm2GYAAAAMSURBVHicY2AgDQAAADAAARaJmtEAAAAASUVORK5CYII=';
    const preset = {
      sec: 'getSeconds',
      min: 'getMinutes',
      hrs: 'getHours'
    }

    const fav = document.getElementById('fav');
    const prev = document.getElementById('prev');

    // w = window
    // t = tab
    // m = method
    // o = timeout
    const w = +(window.location.href.match(/w=(\d+)/) || [])[1];
    const t = +(window.location.href.match(/t=(\d+)/) || [])[1];
    const m = preset[(window.location.href.match(/m=(.{3})/) || [null, 'sec'])[1] || 'sec'];
    const o = +(window.location.href.match(/o=(\d+)/) || [null, '0'])[1] || 0;
    console.log('config', w, t, m, o);

    if (!w || !t) alert('missing required parameter "w" or "t"');
    else {
      document.title = `client ${w}, ${t}`;
      fav.href = transparent;
      
      (async function () {
        window.frames = [];
        window.delay = 1000;
        let frameCount = 1;
        let status = 'idle';

        fetch('/meta')
          .then(res => res.json())
          .then(res => window.delay = res.interval);

        const wait = setInterval(() => {
          if ((new Date()[m] || (() => 0))() === o) {
            start();
            clearInterval(wait);
          }
        }, 20);

        function start (delay) {
          if (status === 'started') return;
          status = 'started';
          if (delay) window.delay = delay;
          window.timer = setInterval(() => {
            const frame = window.frames[frameCount - 1];
            if (!frame) {
              clearInterval(window.timer);
              status = 'idle';

              return console.log('fin');
            }

            fav.href = frame;
            frameCount++;
          }, window.delay);
        }

        const frames = await fetch(`/frames?frame=all&offsetX=${t}&offsetY=${w}`).then(res => res.json());
        window.frames = frames.data;
      })();
    }
  </script>
</body>
</html>